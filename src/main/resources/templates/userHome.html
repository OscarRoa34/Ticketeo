<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticketeo | Descubre Eventos</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>

<body>

<div th:replace="~{fragments/navbar :: navbar-user}"></div>

<header class="hero-section">
    <h1 class="hero-title">Encuentra tu próximo evento</h1>
</header>

<div class="carousel-container" th:if="${not #lists.isEmpty(carouselEvents)}">
    <div class="carousel-wrapper">
        <div class="carousel-slide" th:each="event, iterStat : ${carouselEvents}" th:classappend="${iterStat.index == 0} ? 'active' : ''">
            <img th:src="${event.imageUrl}" th:alt="${event.name}" class="carousel-image">
            <div class="carousel-content">
                <span class="category-badge carousel-category" th:text="${event.category.name}" th:style="'background-color:' + ${event.category.color} + ';'">Categoría</span>
                <h2 class="carousel-title" th:text="${event.name}">Nombre del Evento</h2>
                <p class="carousel-description" th:text="${event.description}">Descripción del evento</p>
                <div class="carousel-meta">
                    <span class="carousel-meta-item">
                        <span style="margin-right: 5px;">Fecha:</span>
                        <span th:text="${#temporals.format(event.date, 'dd/MM/yyyy')}">Fecha</span>
                    </span>
                    <span class="carousel-meta-item">
                        <span style="margin-right: 5px;">Precio:</span>
                        <span class="price-tag" th:data-price="${event.price}" th:text="${event.price == 0.0 ? 'Gratis' : '$' + event.price}">Precio</span>
                    </span>
                </div>
                <a th:href="@{/event/{id}(id=${event.id})}" class="btn-primary carousel-btn">Ver Detalles</a>
            </div>
        </div>
    </div>
    <div class="carousel-indicators">
        <span class="carousel-dot" th:each="event, iterStat : ${carouselEvents}" th:classappend="${iterStat.index == 0} ? 'active' : ''" th:data-index="${iterStat.index}"></span>
    </div>
</div>

<main class="container main-content">

    <div class="filters-bar" style="margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
        <h2 style="color: var(--primary); font-size: 1.8rem;">Eventos Disponibles</h2>

        <form th:action="@{/user}" method="get" id="sortForm" style="display: flex; align-items: center; gap: 10px;">
            <input type="hidden" name="search" th:value="${currentSearch}" th:if="${currentSearch != null}" />
            <input type="hidden" name="categoryId" th:value="${currentCategory}" th:if="${currentCategory != null}" />

            <label for="sort" style="font-weight: 600; color: var(--gray-1); margin-right: 10px; font-size: 1.1rem;">Ordenar por:</label>
            <select name="sort" id="sort" onchange="this.form.submit()"
                    style="padding: 10px 30px 10px 15px; width: auto; max-width: 200px; border-radius: 50px; border: 1px solid var(--gray-5); cursor: pointer; color: var(--black-2); font-weight: 600; background: white; outline: none; transition: all 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-size: 0.9rem; appearance: none; -webkit-appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 12px center; background-size: 10px;">
                <option value="date_desc" th:selected="${currentSort == 'date_desc'}">Recién Añadidos</option>
                <option value="date_asc" th:selected="${currentSort == 'date_asc'}">Próximos Eventos</option>
                <option value="price_asc" th:selected="${currentSort == 'price_asc'}">$ Menor - Mayor</option>
                <option value="price_desc" th:selected="${currentSort == 'price_desc'}">$ Mayor - Menor</option>
            </select>
        </form>
    </div>

    <div class="events-grid">

        <article class="event-card" th:each="event : ${events}">

            <img th:src="${event.imageUrl}" class="card-image" th:alt="${event.name}">

            <div class="card-body">
                <span class="category-badge" th:text="${event.category.name}" th:style="'background-color:' + ${event.category.color} + ';'">Categoría</span>

                <h2 class="card-title" th:text="${event.name}">Nombre del Evento</h2>

                <p class="card-description" th:text="${event.description}">Descripción y detalles del evento.</p>

                <div class="card-footer">
                    <span class="price-tag" th:data-price="${event.price}" th:text="${event.price == 0.0 ? 'Gratis' : '$' + event.price}">$0</span>

                    <a th:href="@{/event/{id}(id=${event.id})}" class="btn-secondary">Ver Detalles</a>
                </div>
            </div>
        </article>

        <div th:if="${#lists.isEmpty(events)}" class="no-events-message" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
            <h3>No hay eventos disponibles en este momento.</h3>
            <p>¡Vuelve pronto para descubrir nuevas experiencias!</p>
        </div>

    </div>

    <div class="pagination-container" th:if="${totalPages > 1}">
        <ul class="pagination">
            <li>
                <a th:href="@{/user(page=${currentPage > 0 ? currentPage - 1 : 0}, search=${currentSearch}, categoryId=${currentCategory}, sort=${currentSort})}"
                   class="page-link"
                   th:classappend="${currentPage == 0} ? 'disabled' : ''">
                    &laquo; Anterior
                </a>
            </li>

            <li th:if="${currentPage > 2}">
                <a th:href="@{/user(page=0, search=${currentSearch}, categoryId=${currentCategory}, sort=${currentSort})}" class="page-link">1</a>
            </li>

            <li th:if="${currentPage > 3}">
                <span class="page-dots">...</span>
            </li>

            <li th:if="${currentPage > 1}">
                <a th:href="@{/user(page=${currentPage - 1}, search=${currentSearch}, categoryId=${currentCategory}, sort=${currentSort})}" class="page-link" th:text="${currentPage}">Prev</a>
            </li>

            <li>
                <a href="#" class="page-link active" th:text="${currentPage + 1}">Current</a>
            </li>

            <li th:if="${currentPage < totalPages - 2}">
                <a th:href="@{/user(page=${currentPage + 1}, search=${currentSearch}, categoryId=${currentCategory}, sort=${currentSort})}" class="page-link" th:text="${currentPage + 2}">Next</a>
            </li>

            <li th:if="${currentPage < totalPages - 4}">
                <span class="page-dots">...</span>
            </li>

            <li th:if="${currentPage < totalPages - 3}">
                <a th:href="@{/user(page=${totalPages - 1}, search=${currentSearch}, categoryId=${currentCategory}, sort=${currentSort})}" class="page-link" th:text="${totalPages}">Last</a>
            </li>

            <li>
                <a th:href="@{/user(page=${currentPage < totalPages - 1 ? currentPage + 1 : currentPage}, search=${currentSearch}, categoryId=${currentCategory}, sort=${currentSort})}"
                   class="page-link"
                   th:classappend="${currentPage >= totalPages - 1} ? 'disabled' : ''">
                    Siguiente &raquo;
                </a>
            </li>
        </ul>
    </div>

</main>

<div th:replace="~{fragments/footer :: footer}"></div>

<script>
    function formatPrice() {
        const priceElements = document.querySelectorAll('.price-tag');
        priceElements.forEach(el => {
            const price = el.getAttribute('data-price');
            if (price && parseFloat(price) !== 0) {
                const formattedPrice = new Intl.NumberFormat('es-CO', {
                    style: 'currency',
                    currency: 'COP',
                    minimumFractionDigits: 0
                }).format(parseFloat(price));
                el.textContent = formattedPrice;
            }
        });
    }

    let currentSlide = 0;
    let carouselInterval;

    function initCarousel() {
        const slides = document.querySelectorAll('.carousel-slide');
        const dots = document.querySelectorAll('.carousel-dot');

        if (slides.length === 0) return;

        function showSlide(index) {
            slides.forEach((slide, i) => {
                slide.classList.remove('active');
                if (i === index) {
                    slide.classList.add('active');
                }
            });

            dots.forEach((dot, i) => {
                dot.classList.remove('active');
                if (i === index) {
                    dot.classList.add('active');
                }
            });
        }

        function nextSlide() {
            currentSlide = (currentSlide + 1) % slides.length;
            showSlide(currentSlide);
        }

        dots.forEach((dot, index) => {
            dot.addEventListener('click', () => {
                currentSlide = index;
                showSlide(currentSlide);
                clearInterval(carouselInterval);
                carouselInterval = setInterval(nextSlide, 7000);
            });
        });

        carouselInterval = setInterval(nextSlide, 7000);
    }

    document.addEventListener('DOMContentLoaded', () => {
        formatPrice();
        initCarousel();
    });
</script>
</body>
</html>